/*
 * grunt-livereload
 * https://github.com/ericclemmons/grunt-livereload
 *
 * Copyright (c) 2013 Eric Clemmons
 * Licensed under the MIT license.
 */

'use strict';

var gaze    = require('gaze');
var path    = require('path');
var server  = require('./lib/server.js');

module.exports = function(grunt) {

  var started = false;

  grunt.registerTask('livereload', 'Start/Reload a LiveReload server', function() {
    this.requiresConfig('livereload', 'livereload.files', 'livereload.options.base');

    var config  = grunt.config('livereload');
    var files   = grunt.file.expand(config.files);
    var base    = grunt.file.expand(config.options.base || '.')[0];
    // utils was renamed to util with v0.4.0. Use fallback for backwards compatibility
    var util    = grunt.util || grunt.utils;

    if (started) {
      server.reload();

      grunt.log.writeln("LiveReload " + "reloaded".cyan);
    } else {
      if (server.start()) {
        grunt.log.writeln("LiveReload server " + "started".cyan + " on port " + server.port.toString());
      } else {
        grunt.log.writeln("LiveReload is already " + "started".red);
      }

      started = true;

      gaze(files, function(err) {
        this.on('all', util._.debounce(function(event, filepath) {
          var relative = server.reloadRelative(base, filepath);

          grunt.log.writeln("LiveReload reloaded " + relative.cyan);
        }, 250));
      });
    }
  });

};
